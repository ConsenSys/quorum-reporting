package storageparsing

import (
	"encoding/json"
	"github.com/stretchr/testify/assert"
	"quorumengineering/quorum-report/types"
	"testing"
)

const storageABI = "{\"storage\":[{\"astId\":3,\"contract\":\"/Users/peter/IdeaProjects/quorum-examples/examples/7nodes/simplestorage.sol:SimpleStorage\",\"label\":\"a\",\"offset\":0,\"slot\":\"0\",\"type\":\"t_uint256\"},{\"astId\":5,\"contract\":\"/Users/peter/IdeaProjects/quorum-examples/examples/7nodes/simplestorage.sol:SimpleStorage\",\"label\":\"b\",\"offset\":0,\"slot\":\"1\",\"type\":\"t_uint8\"},{\"astId\":7,\"contract\":\"/Users/peter/IdeaProjects/quorum-examples/examples/7nodes/simplestorage.sol:SimpleStorage\",\"label\":\"c\",\"offset\":1,\"slot\":\"1\",\"type\":\"t_uint8\"},{\"astId\":9,\"contract\":\"/Users/peter/IdeaProjects/quorum-examples/examples/7nodes/simplestorage.sol:SimpleStorage\",\"label\":\"d\",\"offset\":0,\"slot\":\"2\",\"type\":\"t_int256\"},{\"astId\":11,\"contract\":\"/Users/peter/IdeaProjects/quorum-examples/examples/7nodes/simplestorage.sol:SimpleStorage\",\"label\":\"d2\",\"offset\":0,\"slot\":\"3\",\"type\":\"t_int256\"},{\"astId\":13,\"contract\":\"/Users/peter/IdeaProjects/quorum-examples/examples/7nodes/simplestorage.sol:SimpleStorage\",\"label\":\"d3\",\"offset\":0,\"slot\":\"4\",\"type\":\"t_int8\"},{\"astId\":15,\"contract\":\"/Users/peter/IdeaProjects/quorum-examples/examples/7nodes/simplestorage.sol:SimpleStorage\",\"label\":\"d4\",\"offset\":1,\"slot\":\"4\",\"type\":\"t_int24\"},{\"astId\":17,\"contract\":\"/Users/peter/IdeaProjects/quorum-examples/examples/7nodes/simplestorage.sol:SimpleStorage\",\"label\":\"e\",\"offset\":4,\"slot\":\"4\",\"type\":\"t_bool\"},{\"astId\":19,\"contract\":\"/Users/peter/IdeaProjects/quorum-examples/examples/7nodes/simplestorage.sol:SimpleStorage\",\"label\":\"f\",\"offset\":5,\"slot\":\"4\",\"type\":\"t_address\"},{\"astId\":21,\"contract\":\"/Users/peter/IdeaProjects/quorum-examples/examples/7nodes/simplestorage.sol:SimpleStorage\",\"label\":\"g\",\"offset\":0,\"slot\":\"5\",\"type\":\"t_contract(SimpleStorage)576\"},{\"astId\":23,\"contract\":\"/Users/peter/IdeaProjects/quorum-examples/examples/7nodes/simplestorage.sol:SimpleStorage\",\"label\":\"h1\",\"offset\":20,\"slot\":\"5\",\"type\":\"t_bytes1\"},{\"astId\":25,\"contract\":\"/Users/peter/IdeaProjects/quorum-examples/examples/7nodes/simplestorage.sol:SimpleStorage\",\"label\":\"h2\",\"offset\":21,\"slot\":\"5\",\"type\":\"t_bytes1\"},{\"astId\":27,\"contract\":\"/Users/peter/IdeaProjects/quorum-examples/examples/7nodes/simplestorage.sol:SimpleStorage\",\"label\":\"h3\",\"offset\":22,\"slot\":\"5\",\"type\":\"t_bytes2\"},{\"astId\":29,\"contract\":\"/Users/peter/IdeaProjects/quorum-examples/examples/7nodes/simplestorage.sol:SimpleStorage\",\"label\":\"h4\",\"offset\":0,\"slot\":\"6\",\"type\":\"t_bytes31\"},{\"astId\":31,\"contract\":\"/Users/peter/IdeaProjects/quorum-examples/examples/7nodes/simplestorage.sol:SimpleStorage\",\"label\":\"h5\",\"offset\":0,\"slot\":\"7\",\"type\":\"t_bytes32\"},{\"astId\":38,\"contract\":\"/Users/peter/IdeaProjects/quorum-examples/examples/7nodes/simplestorage.sol:SimpleStorage\",\"label\":\"choice\",\"offset\":0,\"slot\":\"8\",\"type\":\"t_enum(ActionChoices)36\"},{\"astId\":40,\"contract\":\"/Users/peter/IdeaProjects/quorum-examples/examples/7nodes/simplestorage.sol:SimpleStorage\",\"label\":\"lessThan31\",\"offset\":0,\"slot\":\"9\",\"type\":\"t_bytes_storage\"},{\"astId\":42,\"contract\":\"/Users/peter/IdeaProjects/quorum-examples/examples/7nodes/simplestorage.sol:SimpleStorage\",\"label\":\"exactly31\",\"offset\":0,\"slot\":\"10\",\"type\":\"t_bytes_storage\"},{\"astId\":44,\"contract\":\"/Users/peter/IdeaProjects/quorum-examples/examples/7nodes/simplestorage.sol:SimpleStorage\",\"label\":\"exactly32\",\"offset\":0,\"slot\":\"11\",\"type\":\"t_bytes_storage\"},{\"astId\":46,\"contract\":\"/Users/peter/IdeaProjects/quorum-examples/examples/7nodes/simplestorage.sol:SimpleStorage\",\"label\":\"moreThan31\",\"offset\":0,\"slot\":\"12\",\"type\":\"t_bytes_storage\"},{\"astId\":48,\"contract\":\"/Users/peter/IdeaProjects/quorum-examples/examples/7nodes/simplestorage.sol:SimpleStorage\",\"label\":\"i2\",\"offset\":0,\"slot\":\"13\",\"type\":\"t_string_storage\"},{\"astId\":50,\"contract\":\"/Users/peter/IdeaProjects/quorum-examples/examples/7nodes/simplestorage.sol:SimpleStorage\",\"label\":\"i5\",\"offset\":0,\"slot\":\"14\",\"type\":\"t_string_storage\"},{\"astId\":52,\"contract\":\"/Users/peter/IdeaProjects/quorum-examples/examples/7nodes/simplestorage.sol:SimpleStorage\",\"label\":\"i6\",\"offset\":0,\"slot\":\"15\",\"type\":\"t_string_storage\"},{\"astId\":55,\"contract\":\"/Users/peter/IdeaProjects/quorum-examples/examples/7nodes/simplestorage.sol:SimpleStorage\",\"label\":\"h6\",\"offset\":0,\"slot\":\"16\",\"type\":\"t_array(t_bytes1)dyn_storage\"},{\"astId\":58,\"contract\":\"/Users/peter/IdeaProjects/quorum-examples/examples/7nodes/simplestorage.sol:SimpleStorage\",\"label\":\"h6long\",\"offset\":0,\"slot\":\"17\",\"type\":\"t_array(t_bytes1)dyn_storage\"},{\"astId\":62,\"contract\":\"/Users/peter/IdeaProjects/quorum-examples/examples/7nodes/simplestorage.sol:SimpleStorage\",\"label\":\"h7\",\"offset\":0,\"slot\":\"18\",\"type\":\"t_array(t_bytes1)10_storage\"},{\"astId\":66,\"contract\":\"/Users/peter/IdeaProjects/quorum-examples/examples/7nodes/simplestorage.sol:SimpleStorage\",\"label\":\"h7long\",\"offset\":0,\"slot\":\"19\",\"type\":\"t_array(t_bytes1)60_storage\"},{\"astId\":69,\"contract\":\"/Users/peter/IdeaProjects/quorum-examples/examples/7nodes/simplestorage.sol:SimpleStorage\",\"label\":\"i3\",\"offset\":0,\"slot\":\"21\",\"type\":\"t_array(t_address)dyn_storage\"},{\"astId\":72,\"contract\":\"/Users/peter/IdeaProjects/quorum-examples/examples/7nodes/simplestorage.sol:SimpleStorage\",\"label\":\"i4\",\"offset\":0,\"slot\":\"22\",\"type\":\"t_array(t_contract(SimpleStorage)576)dyn_storage\"},{\"astId\":76,\"contract\":\"/Users/peter/IdeaProjects/quorum-examples/examples/7nodes/simplestorage.sol:SimpleStorage\",\"label\":\"doubleArray\",\"offset\":0,\"slot\":\"23\",\"type\":\"t_array(t_array(t_int256)dyn_storage)dyn_storage\"},{\"astId\":83,\"contract\":\"/Users/peter/IdeaProjects/quorum-examples/examples/7nodes/simplestorage.sol:SimpleStorage\",\"label\":\"funder1\",\"offset\":0,\"slot\":\"24\",\"type\":\"t_struct(Funder)81_storage\"},{\"astId\":87,\"contract\":\"/Users/peter/IdeaProjects/quorum-examples/examples/7nodes/simplestorage.sol:SimpleStorage\",\"label\":\"fundersFixed\",\"offset\":0,\"slot\":\"26\",\"type\":\"t_array(t_struct(Funder)81_storage)2_storage\"},{\"astId\":90,\"contract\":\"/Users/peter/IdeaProjects/quorum-examples/examples/7nodes/simplestorage.sol:SimpleStorage\",\"label\":\"fundersDyn\",\"offset\":0,\"slot\":\"30\",\"type\":\"t_array(t_struct(Funder)81_storage)dyn_storage\"},{\"astId\":108,\"contract\":\"/Users/peter/IdeaProjects/quorum-examples/examples/7nodes/simplestorage.sol:SimpleStorage\",\"label\":\"longstruct\",\"offset\":0,\"slot\":\"31\",\"type\":\"t_struct(LongerStruct)106_storage\"},{\"astId\":110,\"contract\":\"/Users/peter/IdeaProjects/quorum-examples/examples/7nodes/simplestorage.sol:SimpleStorage\",\"label\":\"longstruct2\",\"offset\":0,\"slot\":\"38\",\"type\":\"t_struct(LongerStruct)106_storage\"},{\"astId\":112,\"contract\":\"/Users/peter/IdeaProjects/quorum-examples/examples/7nodes/simplestorage.sol:SimpleStorage\",\"label\":\"longstruct3\",\"offset\":0,\"slot\":\"45\",\"type\":\"t_struct(LongerStruct)106_storage\"},{\"astId\":116,\"contract\":\"/Users/peter/IdeaProjects/quorum-examples/examples/7nodes/simplestorage.sol:SimpleStorage\",\"label\":\"map\",\"offset\":0,\"slot\":\"52\",\"type\":\"t_mapping(t_uint256,t_uint256)\"}],\"types\":{\"t_address\":{\"encoding\":\"inplace\",\"label\":\"address\",\"numberOfBytes\":\"20\"},\"t_array(t_address)dyn_storage\":{\"base\":\"t_address\",\"encoding\":\"dynamic_array\",\"label\":\"address[]\",\"numberOfBytes\":\"32\"},\"t_array(t_array(t_int256)dyn_storage)dyn_storage\":{\"base\":\"t_array(t_int256)dyn_storage\",\"encoding\":\"dynamic_array\",\"label\":\"int256[][]\",\"numberOfBytes\":\"32\"},\"t_array(t_bytes1)10_storage\":{\"base\":\"t_bytes1\",\"encoding\":\"inplace\",\"label\":\"bytes1[10]\",\"numberOfBytes\":\"32\"},\"t_array(t_bytes1)60_storage\":{\"base\":\"t_bytes1\",\"encoding\":\"inplace\",\"label\":\"bytes1[60]\",\"numberOfBytes\":\"64\"},\"t_array(t_bytes1)dyn_storage\":{\"base\":\"t_bytes1\",\"encoding\":\"dynamic_array\",\"label\":\"bytes1[]\",\"numberOfBytes\":\"32\"},\"t_array(t_contract(SimpleStorage)576)dyn_storage\":{\"base\":\"t_contract(SimpleStorage)576\",\"encoding\":\"dynamic_array\",\"label\":\"contract SimpleStorage[]\",\"numberOfBytes\":\"32\"},\"t_array(t_int256)dyn_storage\":{\"base\":\"t_int256\",\"encoding\":\"dynamic_array\",\"label\":\"int256[]\",\"numberOfBytes\":\"32\"},\"t_array(t_struct(Funder)81_storage)2_storage\":{\"base\":\"t_struct(Funder)81_storage\",\"encoding\":\"inplace\",\"label\":\"struct SimpleStorage.Funder[2]\",\"numberOfBytes\":\"128\"},\"t_array(t_struct(Funder)81_storage)dyn_storage\":{\"base\":\"t_struct(Funder)81_storage\",\"encoding\":\"dynamic_array\",\"label\":\"struct SimpleStorage.Funder[]\",\"numberOfBytes\":\"32\"},\"t_bool\":{\"encoding\":\"inplace\",\"label\":\"bool\",\"numberOfBytes\":\"1\"},\"t_bytes1\":{\"encoding\":\"inplace\",\"label\":\"bytes1\",\"numberOfBytes\":\"1\"},\"t_bytes2\":{\"encoding\":\"inplace\",\"label\":\"bytes2\",\"numberOfBytes\":\"2\"},\"t_bytes31\":{\"encoding\":\"inplace\",\"label\":\"bytes31\",\"numberOfBytes\":\"31\"},\"t_bytes32\":{\"encoding\":\"inplace\",\"label\":\"bytes32\",\"numberOfBytes\":\"32\"},\"t_bytes_storage\":{\"encoding\":\"bytes\",\"label\":\"bytes\",\"numberOfBytes\":\"32\"},\"t_contract(SimpleStorage)576\":{\"encoding\":\"inplace\",\"label\":\"contract SimpleStorage\",\"numberOfBytes\":\"20\"},\"t_enum(ActionChoices)36\":{\"encoding\":\"inplace\",\"label\":\"enum SimpleStorage.ActionChoices\",\"numberOfBytes\":\"1\"},\"t_int24\":{\"encoding\":\"inplace\",\"label\":\"int24\",\"numberOfBytes\":\"3\"},\"t_int256\":{\"encoding\":\"inplace\",\"label\":\"int256\",\"numberOfBytes\":\"32\"},\"t_int8\":{\"encoding\":\"inplace\",\"label\":\"int8\",\"numberOfBytes\":\"1\"},\"t_mapping(t_uint256,t_uint256)\":{\"encoding\":\"mapping\",\"key\":\"t_uint256\",\"label\":\"mapping(uint256 => uint256)\",\"numberOfBytes\":\"32\",\"value\":\"t_uint256\"},\"t_string_storage\":{\"encoding\":\"bytes\",\"label\":\"string\",\"numberOfBytes\":\"32\"},\"t_struct(Funder)81_storage\":{\"encoding\":\"inplace\",\"label\":\"struct SimpleStorage.Funder\",\"members\":[{\"astId\":78,\"contract\":\"/Users/peter/IdeaProjects/quorum-examples/examples/7nodes/simplestorage.sol:SimpleStorage\",\"label\":\"addr\",\"offset\":0,\"slot\":\"0\",\"type\":\"t_string_storage\"},{\"astId\":80,\"contract\":\"/Users/peter/IdeaProjects/quorum-examples/examples/7nodes/simplestorage.sol:SimpleStorage\",\"label\":\"amount\",\"offset\":0,\"slot\":\"1\",\"type\":\"t_uint256\"}],\"numberOfBytes\":\"64\"},\"t_struct(LongerStruct)106_storage\":{\"encoding\":\"inplace\",\"label\":\"struct SimpleStorage.LongerStruct\",\"members\":[{\"astId\":92,\"contract\":\"/Users/peter/IdeaProjects/quorum-examples/examples/7nodes/simplestorage.sol:SimpleStorage\",\"label\":\"addr\",\"offset\":0,\"slot\":\"0\",\"type\":\"t_string_storage\"},{\"astId\":94,\"contract\":\"/Users/peter/IdeaProjects/quorum-examples/examples/7nodes/simplestorage.sol:SimpleStorage\",\"label\":\"amount\",\"offset\":0,\"slot\":\"1\",\"type\":\"t_uint256\"},{\"astId\":96,\"contract\":\"/Users/peter/IdeaProjects/quorum-examples/examples/7nodes/simplestorage.sol:SimpleStorage\",\"label\":\"val\",\"offset\":0,\"slot\":\"2\",\"type\":\"t_int8\"},{\"astId\":98,\"contract\":\"/Users/peter/IdeaProjects/quorum-examples/examples/7nodes/simplestorage.sol:SimpleStorage\",\"label\":\"otherval\",\"offset\":1,\"slot\":\"2\",\"type\":\"t_uint8\"},{\"astId\":100,\"contract\":\"/Users/peter/IdeaProjects/quorum-examples/examples/7nodes/simplestorage.sol:SimpleStorage\",\"label\":\"custommessage\",\"offset\":0,\"slot\":\"3\",\"type\":\"t_string_storage\"},{\"astId\":102,\"contract\":\"/Users/peter/IdeaProjects/quorum-examples/examples/7nodes/simplestorage.sol:SimpleStorage\",\"label\":\"otherStruct\",\"offset\":0,\"slot\":\"4\",\"type\":\"t_struct(Funder)81_storage\"},{\"astId\":105,\"contract\":\"/Users/peter/IdeaProjects/quorum-examples/examples/7nodes/simplestorage.sol:SimpleStorage\",\"label\":\"bigIntArray\",\"offset\":0,\"slot\":\"6\",\"type\":\"t_array(t_int256)dyn_storage\"}],\"numberOfBytes\":\"224\"},\"t_uint256\":{\"encoding\":\"inplace\",\"label\":\"uint256\",\"numberOfBytes\":\"32\"},\"t_uint8\":{\"encoding\":\"inplace\",\"label\":\"uint8\",\"numberOfBytes\":\"1\"}}}"

const rawStorage = `
{
    "0x0000000000000000000000000000000000000000000000000000000000000000": "2a",
    "0x0000000000000000000000000000000000000000000000000000000000000001": "0906",
    "0x0000000000000000000000000000000000000000000000000000000000000002": "ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffd6",
    "0x0000000000000000000000000000000000000000000000000000000000000003": "41",
    "0x0000000000000000000000000000000000000000000000000000000000000004": "dcad3a6d3569df655070ded06cb7a1b2ccd1d3af01ace8bb78",
    "0x0000000000000000000000000000000000000000000000000000000000000005": "10000001dcad3a6d3569df655070ded06cb7a1b2ccd1d3af",
    "0x0000000000000000000000000000000000000000000000000000000000000006": "10000000000000000000000000000000000000000000000000000000000000",
    "0x0000000000000000000000000000000000000000000000000000000000000007": "1000000000000000000000000000000000000000000000000000000000000000",
    "0x0000000000000000000000000000000000000000000000000000000000000009": "0102030405060708090a0b0c0d0e0f10111213000000000000000000000028",
    "0x000000000000000000000000000000000000000000000000000000000000000a": "0102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e3e",
    "0x000000000000000000000000000000000000000000000000000000000000000b": "41",
    "0x000000000000000000000000000000000000000000000000000000000000000c": "c9",
    "0x000000000000000000000000000000000000000000000000000000000000000d": "6d79737472696e67000000000000000000000000000000000000000000000010",
    "0x000000000000000000000000000000000000000000000000000000000000000e": "8d",
    "0x000000000000000000000000000000000000000000000000000000000000000f": "01af",
    "0x0000000000000000000000000000000000000000000000000000000000000010": "01",
    "0x0000000000000000000000000000000000000000000000000000000000000011": "28",
    "0x0000000000000000000000000000000000000000000000000000000000000012": "01000000000101010001",
    "0x0000000000000000000000000000000000000000000000000000000000000013": "1f1e1d1c1b1a191817161514131211100f0e0d0c0b0a09080706050403020100",
    "0x0000000000000000000000000000000000000000000000000000000000000014": "3a393837363534333231302f2e2d2c2b2a29282726252423222120",
    "0x0000000000000000000000000000000000000000000000000000000000000017": "02",
    "0x0000000000000000000000000000000000000000000000000000000000000018": "736f6d6520616464720000000000000000000000000000000000000000000012",
    "0x0000000000000000000000000000000000000000000000000000000000000019": "38",
    "0x000000000000000000000000000000000000000000000000000000000000001a": "736f6d6520616464722066697865642031000000000000000000000000000022",
    "0x000000000000000000000000000000000000000000000000000000000000001b": "55",
    "0x000000000000000000000000000000000000000000000000000000000000001c": "736f6d6520616464722066697865642032000000000000000000000000000022",
    "0x000000000000000000000000000000000000000000000000000000000000001d": "19a5",
    "0x000000000000000000000000000000000000000000000000000000000000001e": "03",
    "0x000000000000000000000000000000000000000000000000000000000000001f": "736f6d6520616464722066697865642036000000000000000000000000000022",
    "0x0000000000000000000000000000000000000000000000000000000000000020": "4a64b3",
    "0x0000000000000000000000000000000000000000000000000000000000000021": "08fa",
    "0x0000000000000000000000000000000000000000000000000000000000000022": "637573746f6d206d65737361676500000000000000000000000000000000001c",
    "0x0000000000000000000000000000000000000000000000000000000000000023": "736f6d6520616464720000000000000000000000000000000000000000000012",
    "0x0000000000000000000000000000000000000000000000000000000000000024": "38",
    "0x0000000000000000000000000000000000000000000000000000000000000025": "07",
    "0x0000000000000000000000000000000000000000000000000000000000000026": "736f6d6520616464722066697865642036000000000000000000000000000022",
    "0x0000000000000000000000000000000000000000000000000000000000000027": "4a64b3",
    "0x0000000000000000000000000000000000000000000000000000000000000028": "08fa",
    "0x0000000000000000000000000000000000000000000000000000000000000029": "637573746f6d206d65737361676500000000000000000000000000000000001c",
    "0x000000000000000000000000000000000000000000000000000000000000002a": "736f6d6520616464722066697865642031000000000000000000000000000022",
    "0x000000000000000000000000000000000000000000000000000000000000002b": "55",
    "0x000000000000000000000000000000000000000000000000000000000000002c": "07",
    "0x000000000000000000000000000000000000000000000000000000000000002d": "736f6d6520616464722066697865642036000000000000000000000000000022",
    "0x000000000000000000000000000000000000000000000000000000000000002e": "4a64b3",
    "0x000000000000000000000000000000000000000000000000000000000000002f": "08fa",
    "0x0000000000000000000000000000000000000000000000000000000000000030": "637573746f6d206d65737361676500000000000000000000000000000000001c",
    "0x0000000000000000000000000000000000000000000000000000000000000031": "6d7973747200000000000000000000000000000000000000000000000000000a",
    "0x0000000000000000000000000000000000000000000000000000000000000032": "036d",
    "0x0000000000000000000000000000000000000000000000000000000000000033": "07",
    "0x0175b7a638427703f0dbe7bb9bbf987a2551717b34e79f33b5b1008d1fa01db9": "0102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f",
    "0x1b6847dc741a1b0cd08d278845f9d819d87b734759afb55fe2de5cb82a9ae672": "01",
    "0x31ecc21a745e3968a04e9570e4425bc18fa8019c68028196b546d1669c200c68": "1f1e1d1c1b1a191817161514131211100f0e0d0c0b0a09080706050403020100",
    "0x31ecc21a745e3968a04e9570e4425bc18fa8019c68028196b546d1669c200c69": "2726252423222120",
    "0x401968ff42a154441da5f6c4c935ac46b8671f0e062baaa62a7545ba53bb6e4c": "38",
    "0x401968ff42a154441da5f6c4c935ac46b8671f0e062baaa62a7545ba53bb6e4f": "2b",
    "0x401968ff42a154441da5f6c4c935ac46b8671f0e062baaa62a7545ba53bb6e50": "20",
    "0x401968ff42a154441da5f6c4c935ac46b8671f0e062baaa62a7545ba53bb6e52": "41",
    "0x50bb669a95c7b50b7e8a6f09454034b2b14cf2b85c730dca9a539ca82cb6e350": "736f6d6520616464722066697865642033000000000000000000000000000022",
    "0x50bb669a95c7b50b7e8a6f09454034b2b14cf2b85c730dca9a539ca82cb6e351": "012a15",
    "0x50bb669a95c7b50b7e8a6f09454034b2b14cf2b85c730dca9a539ca82cb6e352": "736f6d6520616464722066697865642034000000000000000000000000000022",
    "0x50bb669a95c7b50b7e8a6f09454034b2b14cf2b85c730dca9a539ca82cb6e353": "16f4",
    "0x50bb669a95c7b50b7e8a6f09454034b2b14cf2b85c730dca9a539ca82cb6e354": "736f6d6520616464722066697865642035000000000000000000000000000022",
    "0x50bb669a95c7b50b7e8a6f09454034b2b14cf2b85c730dca9a539ca82cb6e355": "4a64b3",
    "0x7416c943b4a09859521022fd2e90eac0dd9026dad28fa317782a135f28a86091": "38",
    "0x7416c943b4a09859521022fd2e90eac0dd9026dad28fa317782a135f28a86094": "2b",
    "0x7416c943b4a09859521022fd2e90eac0dd9026dad28fa317782a135f28a86095": "20",
    "0x7416c943b4a09859521022fd2e90eac0dd9026dad28fa317782a135f28a86097": "41",
    "0x82a75bdeeae8604d839476ae9efd8b0e15aa447e21bfd7f41283bb54e22c9a82": "01",
    "0x82a75bdeeae8604d839476ae9efd8b0e15aa447e21bfd7f41283bb54e22c9a85": "02",
    "0x82a75bdeeae8604d839476ae9efd8b0e15aa447e21bfd7f41283bb54e22c9a86": "01",
    "0x82a75bdeeae8604d839476ae9efd8b0e15aa447e21bfd7f41283bb54e22c9a88": "01",
    "0x8d1108e10bcb7c27dddfc02ed9d693a074039d026cf4ea4240b40f7d581ac802": "6d79207265616c6c79206c6f6e6720737472696e672074686174206973206465",
    "0x8d1108e10bcb7c27dddfc02ed9d693a074039d026cf4ea4240b40f7d581ac803": "66696e6974656c79206c6f6e676572207468616e207468652033322062797465",
    "0x8d1108e10bcb7c27dddfc02ed9d693a074039d026cf4ea4240b40f7d581ac804": "206c696d69742e206d79207265616c6c79206c6f6e6720737472696e67207468",
    "0x8d1108e10bcb7c27dddfc02ed9d693a074039d026cf4ea4240b40f7d581ac805": "617420697320646566696e6974656c79206c6f6e676572207468616e20746865",
    "0x8d1108e10bcb7c27dddfc02ed9d693a074039d026cf4ea4240b40f7d581ac806": "2033322062797465206c696d69742e206d79207265616c6c79206c6f6e672073",
    "0x8d1108e10bcb7c27dddfc02ed9d693a074039d026cf4ea4240b40f7d581ac807": "7472696e67207468617420697320646566696e6974656c79206c6f6e67657220",
    "0x8d1108e10bcb7c27dddfc02ed9d693a074039d026cf4ea4240b40f7d581ac808": "7468616e207468652033322062797465206c696d69742e000000000000000000",
    "0xa6564d01cb04fb0aa9443da7cca21087171ea2bcf4cd8ad84ffca87989b5d42d": "14",
    "0xbb7b4a454dc3493923482f07822329ed19e8244eff582cc204f8554c3620c3fd": "6d79207265616c6c79206c6f6e6720737472696e672074686174206973206465",
    "0xbb7b4a454dc3493923482f07822329ed19e8244eff582cc204f8554c3620c3fe": "66696e6974656c79206c6f6e676572207468616e207468652033322062797465",
    "0xbb7b4a454dc3493923482f07822329ed19e8244eff582cc204f8554c3620c3ff": "206c696d69740000000000000000000000000000000000000000000000000000",
    "0xc624b66cc0138b8fabc209247f72d758e1cf3343756d543badbf24212bed8c15": "07",
    "0xc624b66cc0138b8fabc209247f72d758e1cf3343756d543badbf24212bed8c16": "07",
    "0xcaafa9fa0d8f5c906c617926ea9fbfd7f2e381239be771171dd9a29dab29819c": "0a",
    "0xdf6966c971051c3d54ec59162606531493a51404a002842f56009d7e5cf4a8c7": "0102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f",
    "0xdf6966c971051c3d54ec59162606531493a51404a002842f56009d7e5cf4a8c8": "202122232425262728292a2b2c2d2e2f303132333435363738393a3b3c3d3e3f",
    "0xdf6966c971051c3d54ec59162606531493a51404a002842f56009d7e5cf4a8c9": "404142434445464748494a4b4c4d4e4f505152535455565758595a5b5c5d5e5f",
    "0xdf6966c971051c3d54ec59162606531493a51404a002842f56009d7e5cf4a8ca": "6061626300000000000000000000000000000000000000000000000000000000"
}
`

const expectedOutput = `[{"name":"a","index":0,"type":"uint256","value":"42"},{"name":"b","index":0,"type":"uint8","value":"6"},{"name":"c","index":0,"type":"uint8","value":"9"},{"name":"d","index":0,"type":"int256","value":"-42"},{"name":"d2","index":0,"type":"int256","value":"65"},{"name":"d3","index":0,"type":"int8","value":"120"},{"name":"d4","index":0,"type":"int24","value":"-5445445"},{"name":"e","index":0,"type":"bool","value":true},{"name":"f","index":0,"type":"address","value":"0xdcad3a6d3569df655070ded06cb7a1b2ccd1d3af"},{"name":"g","index":0,"type":"contract SimpleStorage","value":"0xdcad3a6d3569df655070ded06cb7a1b2ccd1d3af"},{"name":"h1","index":0,"type":"bytes1","value":"0x01"},{"name":"h2","index":0,"type":"bytes1","value":"0x00"},{"name":"h3","index":0,"type":"bytes2","value":"0x1000"},{"name":"h4","index":0,"type":"bytes31","value":"0x10000000000000000000000000000000000000000000000000000000000000"},{"name":"h5","index":0,"type":"bytes32","value":"0x1000000000000000000000000000000000000000000000000000000000000000"},{"name":"choice","index":0,"type":"enum SimpleStorage.ActionChoices","value":0},{"name":"lessThan31","index":0,"type":"bytes","value":["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f","10","11","12","13"]},{"name":"exactly31","index":0,"type":"bytes","value":["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f","10","11","12","13","14","15","16","17","18","19","1a","1b","1c","1d","1e"]},{"name":"exactly32","index":0,"type":"bytes","value":["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f","10","11","12","13","14","15","16","17","18","19","1a","1b","1c","1d","1e","1f"]},{"name":"moreThan31","index":0,"type":"bytes","value":["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f","10","11","12","13","14","15","16","17","18","19","1a","1b","1c","1d","1e","1f","20","21","22","23","24","25","26","27","28","29","2a","2b","2c","2d","2e","2f","30","31","32","33","34","35","36","37","38","39","3a","3b","3c","3d","3e","3f","40","41","42","43","44","45","46","47","48","49","4a","4b","4c","4d","4e","4f","50","51","52","53","54","55","56","57","58","59","5a","5b","5c","5d","5e","5f","60","61","62","63"]},{"name":"i2","index":0,"type":"string","value":"mystring"},{"name":"i5","index":0,"type":"string","value":"my really long string that is definitely longer than the 32 byte limit"},{"name":"i6","index":0,"type":"string","value":"my really long string that is definitely longer than the 32 byte limit. my really long string that is definitely longer than the 32 byte limit. my really long string that is definitely longer than the 32 byte limit."},{"name":"h6","index":0,"type":"bytes1[]","value":["0x01"]},{"name":"h6long","index":0,"type":"bytes1[]","value":["0x00","0x01","0x02","0x03","0x04","0x05","0x06","0x07","0x08","0x09","0x0a","0x0b","0x0c","0x0d","0x0e","0x0f","0x10","0x11","0x12","0x13","0x14","0x15","0x16","0x17","0x18","0x19","0x1a","0x1b","0x1c","0x1d","0x1e","0x1f","0x20","0x21","0x22","0x23","0x24","0x25","0x26","0x27"]},{"name":"h7","index":0,"type":"bytes1[10]","value":["0x01","0x00","0x01","0x01","0x01","0x00","0x00","0x00","0x00","0x01"]},{"name":"h7long","index":0,"type":"bytes1[60]","value":["0x00","0x01","0x02","0x03","0x04","0x05","0x06","0x07","0x08","0x09","0x0a","0x0b","0x0c","0x0d","0x0e","0x0f","0x10","0x11","0x12","0x13","0x14","0x15","0x16","0x17","0x18","0x19","0x1a","0x1b","0x1c","0x1d","0x1e","0x1f","0x20","0x21","0x22","0x23","0x24","0x25","0x26","0x27","0x28","0x29","0x2a","0x2b","0x2c","0x2d","0x2e","0x2f","0x30","0x31","0x32","0x33","0x34","0x35","0x36","0x37","0x38","0x39","0x3a","0x00"]},{"name":"i3","index":0,"type":"address[]","value":[]},{"name":"i4","index":0,"type":"contract SimpleStorage[]","value":[]},{"name":"doubleArray","index":0,"type":"int256[][]","value":[["10","0","0","0","0","0","0"],["20","0","0","0","0","0","0"]]},{"name":"funder1","index":0,"type":"struct SimpleStorage.Funder","value":[{"name":"addr","index":0,"type":"string","value":"some addr"},{"name":"amount","index":0,"type":"uint256","value":"56"}]},{"name":"fundersFixed","index":0,"type":"struct SimpleStorage.Funder[2]","value":[[{"name":"addr","index":0,"type":"string","value":"some addr fixed 1"},{"name":"amount","index":0,"type":"uint256","value":"85"}],[{"name":"addr","index":0,"type":"string","value":"some addr fixed 2"},{"name":"amount","index":0,"type":"uint256","value":"6565"}]]},{"name":"fundersDyn","index":0,"type":"struct SimpleStorage.Funder[]","value":[[{"name":"addr","index":0,"type":"string","value":"some addr fixed 3"},{"name":"amount","index":0,"type":"uint256","value":"76309"}],[{"name":"addr","index":0,"type":"string","value":"some addr fixed 4"},{"name":"amount","index":0,"type":"uint256","value":"5876"}],[{"name":"addr","index":0,"type":"string","value":"some addr fixed 5"},{"name":"amount","index":0,"type":"uint256","value":"4875443"}]]},{"name":"longstruct","index":0,"type":"struct SimpleStorage.LongerStruct","value":[{"name":"addr","index":0,"type":"string","value":"some addr fixed 6"},{"name":"amount","index":0,"type":"uint256","value":"4875443"},{"name":"val","index":0,"type":"int8","value":"-6"},{"name":"otherval","index":0,"type":"uint8","value":"8"},{"name":"custommessage","index":0,"type":"string","value":"custom message"},{"name":"otherStruct","index":0,"type":"struct SimpleStorage.Funder","value":[{"name":"addr","index":0,"type":"string","value":"some addr"},{"name":"amount","index":0,"type":"uint256","value":"56"}]},{"name":"bigIntArray","index":0,"type":"int256[]","value":["56","0","0","43","32","0","65"]}]},{"name":"longstruct2","index":0,"type":"struct SimpleStorage.LongerStruct","value":[{"name":"addr","index":0,"type":"string","value":"some addr fixed 6"},{"name":"amount","index":0,"type":"uint256","value":"4875443"},{"name":"val","index":0,"type":"int8","value":"-6"},{"name":"otherval","index":0,"type":"uint8","value":"8"},{"name":"custommessage","index":0,"type":"string","value":"custom message"},{"name":"otherStruct","index":0,"type":"struct SimpleStorage.Funder","value":[{"name":"addr","index":0,"type":"string","value":"some addr fixed 1"},{"name":"amount","index":0,"type":"uint256","value":"85"}]},{"name":"bigIntArray","index":0,"type":"int256[]","value":["56","0","0","43","32","0","65"]}]},{"name":"longstruct3","index":0,"type":"struct SimpleStorage.LongerStruct","value":[{"name":"addr","index":0,"type":"string","value":"some addr fixed 6"},{"name":"amount","index":0,"type":"uint256","value":"4875443"},{"name":"val","index":0,"type":"int8","value":"-6"},{"name":"otherval","index":0,"type":"uint8","value":"8"},{"name":"custommessage","index":0,"type":"string","value":"custom message"},{"name":"otherStruct","index":0,"type":"struct SimpleStorage.Funder","value":[{"name":"addr","index":0,"type":"string","value":"mystr"},{"name":"amount","index":0,"type":"uint256","value":"877"}]},{"name":"bigIntArray","index":0,"type":"int256[]","value":["1","0","0","2","1","0","1"]}]}]`

func TestCorrectParsing(t *testing.T) {
	var decodedStorage map[string]string
	json.Unmarshal([]byte(rawStorage), &decodedStorage)

	convertedStorage := make(map[types.Hash]string)
	for k, v := range decodedStorage {
		convertedStorage[types.NewHash(k)] = v
	}

	var decodedAbi types.SolidityStorageDocument
	json.Unmarshal([]byte(storageABI), &decodedAbi)

	output, err := ParseRawStorage(convertedStorage, decodedAbi)

	assert.Nil(t, err, "unexpected error")

	encoded, err := json.Marshal(output)

	assert.JSONEq(t, expectedOutput, string(encoded), "output was incorrect. Expected %s, but got %s", expectedOutput, encoded)
}
